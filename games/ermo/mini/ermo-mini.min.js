var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),UI;!function(e){function t(e){return e||(e=function(){function e(){}return e}()),function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.pauseEvents=!1,t.triggerGlobally=!0,t}return __extends(t,e),t.prototype.addEventListener=function(e,t,n,r,o){void 0===r&&(r=!0);var s=this._listenerManager||(this._listenerManager=new i(this));return s.addListener(e,t,n,r,o)},t.prototype.removeEventListener=function(e,t){this._listenerManager&&this._listenerManager.removeListener(e,t)},t.prototype.triggerEvent=function(e,t,n){this.pauseEvents||t&&t.pauseEvents||(this._listenerManager&&this._listenerManager.trigger(e,t,n),this.triggerGlobally&&eventHelper.raise(e,t||n))},t}(e)}e.EventedTrait=t;var n=function(){function e(e,t,n,i){this.manager=e,this.event=t,this.callback=n,this.ctx=i}return e.prototype.filterBySource=function(e){return this._filterSource=e,this},e.prototype.filterByType=function(e){return this._filterType=e,this},e.prototype.test=function(e){return!(this._filterSource&&this._filterSource!==e||this._filterType&&!(e instanceof this._filterType))},e.prototype.unregister=function(){this.manager.removeListener(this.callback,this.event)},e}();e.ListenerRegistration=n;var i=function(){function e(e){this.owner=e,this._events={}}return e.prototype.addListener=function(e,t,i,r,o){"function"==typeof t&&(t=new n(this,e,t,i),t.withSource=r,t.additionalArgs=o);var s=this._events,a=s[e];return a?Array.isArray(a)?a.push(t):s[e]=[a,t]:s[e]=t,t},e.prototype.removeListener=function(e,t){if(t){var n=this._events,i=n[t];if(i&&i.callback===e)n[t]=void 0;else if(Array.isArray(i))for(var r=0;r<i.length;r++)if(i[r].callback===e)return void i.splice(r,1)}else for(var o=0,s=Object.getOwnPropertyNames(this._events);o<s.length;o++){var a=s[o];this.removeListener(e,a)}},e.prototype.trigger=function(t,n,i){var r=this._events[t];if(r)if(Array.isArray(r))for(var o=0,s=r;o<s.length;o++){var a=s[o];e.invoke(a,this.owner,n,i)}else e.invoke(r,this.owner,n,i)},e.invoke=function(e,t,n,i){if(e.test(n)){var r=Array.isArray(i),o=Array.isArray(e.additionalArgs);if(r||o){var s=[];e.withSource&&s.push(n||t),r?s.push.apply(s,i):s.push(i),o?s.push.apply(s,e.additionalArgs):s.push(e.additionalArgs),e.callback.apply(e.ctx,s)}else e.withSource?e.callback.call(e.ctx,n||t,i,e.additionalArgs):e.callback.call(e.ctx,i,e.additionalArgs)}},e}()}(UI||(UI={}));var Game;!function(e){var t={modeStarted:"mode_started",modeEnded:"mode_ended",levelStarted:"level_started",levelEnded:"level_ended"},n=function(){function n(){this.EVENT=t,this.typeCatalogue={}}return n.prototype.resetProgress=function(){eventHelper.raise(this.EVENT.levelEnded,userStats.currentLevel),eventHelper.raise(this.EVENT.modeEnded,userStats.currentLevel)},n.prototype.startFromBegin=function(){this.startFrom(0)},n.prototype.startFromMax=function(){var e=userStats.maxLevel;levelCatalogue.isLastLevel(e)||e++,this.startFrom(e)},n.prototype.startFrom=function(e){var t=userStats.maxLevel;e>t+1&&(e=t+1),eventHelper.raise(this.EVENT.modeStarted,e)},n.prototype.newStage=function(t,n,i){var r=i.stages[n].type,o=new this.typeCatalogue[r](i,n);return o.addEventListener(e.StageInstance.EVENT.end,this._onInstanceEnd,this),0===o.stage&&eventHelper.raise(this.EVENT.levelStarted),o},n.prototype._onInstanceEnd=function(t){var n=this;e.Providers.scheduler.schedule(0,function(){t.isCompleted&&t.isLastStage&&(eventHelper.raise(n.EVENT.levelEnded,t.level),levelCatalogue.isLastLevel(t.level)&&eventHelper.raise(n.EVENT.modeEnded,t.level)),t.isFailed&&(eventHelper.raise(n.EVENT.levelEnded,t.level),eventHelper.raise(n.EVENT.modeEnded,t.level))})},n}();e.manager=new n}(Game||(Game={}));var gameManager=Game.manager,Game;!function(e){var t=function(){function e(e,t){this.rows=e,this.columns=t;for(var n=this.tiles=new Array(t),i=0;i<t;i++)for(var r=(n[i]=new Array(e),0);r<e;r++)n[i][r]=0}return Object.defineProperty(e.prototype,"hasStore",{get:function(){return!!this.store},enumerable:!0,configurable:!0}),e.prototype.get=function(e,t){return this.tiles[t][e]},e.prototype.set=function(e,t,n){this.tiles[t][e]=n},e.prototype.save=function(){for(var e=this.tiles,t=this.store=new Array(e.length),n=0;n<t.length;n++)t[n]=e[n].slice()},e.prototype.restore=function(){var e=this.tiles,t=this.store;if(t)for(var n=0;n<t.length;n++)e[n]=t[n].slice()},e.prototype.clear=function(){this.store=void 0},e.prototype.isColAligned=function(e){for(var t=this.tiles[e],n=0;n<t.length-1;n++)if(t[n]!==t[n+1])return!1;return!0},e.prototype.isAllColAligned=function(){for(var e=0;e<this.tiles.length;e++)if(!this.isColAligned(e))return!1;return!0},e.prototype.isRowAligned=function(e){for(var t=this.tiles,n=0;n<t.length-1;n++)if(t[n][e]!==t[n+1][e])return!1;return!0},e.prototype.shift=function(e,t){var n,i,r,o,s=this.tiles;switch(e){case 0:for(o=s.length-1,n=s[0][t],r=0;r<o;r++)s[r][t]=s[r+1][t];s[o][t]=n;break;case 2:for(o=s.length-1,n=s[o][t],r=o;r>0;r--)s[r][t]=s[r-1][t];s[0][t]=n;break;case 1:for(i=s[t],o=i.length-1,n=i[o],r=o;r>0;r--)i[r]=i[r-1];i[0]=n;break;case 3:for(i=s[t],o=i.length-1,n=i[0],r=0;r<o;r++)i[r]=i[r+1];i[o]=n}},e}();e.TileGrid=t,e.Providers={uiProvider:void 0,scheduler:void 0},e.GameDirectionsEVENT={click:"menu_click",pressedChanged:"menu_pressedChanged",shift:"buttons_shift"};var n={start:"stage_start",step:"stage_step",end:"stage_end",retry:"stage_retry",powerup:"stage_powerup"},i=function(n){function i(t,i){var r=n.call(this)||this;return r._isCompleted=!1,r._isSuccess=!1,r._isFailed=!1,r._actualMove=0,r._levelConfig=t,r._stage=i||0,r.bar=r.createBar(),r.board=r.createBoard(),r.board.directions.addEventListener(e.GameDirectionsEVENT.shift,r.advance,r,!1),r.reset(),r}return __extends(i,n),Object.defineProperty(i.prototype,"levelConfig",{get:function(){return this._levelConfig},set:function(e){this._levelConfig=e,this._stage=0,this.tiles&&this.tiles.clear(),this.reset()},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"level",{get:function(){return this._levelConfig.index},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"stage",{get:function(){return this._stage},set:function(e){this._stage=e,this.tiles&&this.tiles.clear(),this.reset()},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"stageConfig",{get:function(){return this.levelConfig.stages[this.stage]},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"stageType",{get:function(){return this.stageConfig.type},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isLastStage",{get:function(){return this.levelConfig.stages.length-1===this.stage},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"tileCount",{get:function(){return this.rows*this.columns},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"actualMove",{get:function(){return this._actualMove},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isCompleted",{get:function(){return this._isSuccess||this._isCompleted},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isSuccess",{get:function(){return this._isSuccess},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isFailed",{get:function(){return this._isFailed},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isAllAligned",{get:function(){return this.tiles.isAllColAligned()},enumerable:!0,configurable:!0}),i.prototype.getBar=function(){return this.bar},i.prototype.getBoard=function(){return this.board},i.prototype.getReward=function(){return this._isSuccess?{unit:"energy",quantity:.4+.1*this.level/10}:void 0},i.prototype.getRewardExtra=function(){},i.prototype.generate=function(){var e=this["generate_"+this.stageConfig.layout];if(!e)throw new Error("Invalid layout ["+this.stageConfig.layout+"]");e.call(this),this.bar.initWithInstance(this),this.board.initWithInstance(this)},i.prototype.generate_predefined=function(){for(var e=this.stageConfig,n=this.rows=e.tiles.length,i=this.columns=e.tiles[0].split(",").length,r=this.tiles=new t(n,i),o=0;o<n;o++)for(var s=e.tiles[o].split(","),a=0;a<i;a++)r.set(n-o-1,a,parseInt(s[a],10))},i.prototype.advance=function(e){this._actualMove++,this.tiles.shift(e.direction,e.index),this.board.tiles.shift(e.direction,e.index),this.triggerEvent(i.EVENT.step,this)},i.prototype.usePowerUp=function(e){var t,n,r=powerupCatalogue.get(e);return userInventory.get(r.name)>0?(userInventory.delta(r.name,-1),this.applyPowerUp(e),t="inventory"):userInventory.get("energy")>=r.price?(userInventory.delta("energy",-r.price),this.applyPowerUp(e),t="energy"):(t="none",n="noResource"),eventHelper.raise(i.EVENT.powerup,{name:r.name,source:t}),n},i.prototype.applyPowerUp=function(e){switch(e){case"reset":this.reset(),this.start();break;case"skip":this._isCompleted=!0,this.onEnd()}},i.prototype.start=function(){this.board.directions.register(),this.triggerEvent(i.EVENT.start,this)},i.prototype.endTutorial=function(){},i.prototype.pause=function(){this.board.directions.unregister()},i.prototype.resume=function(){this.board.directions.register()},i.prototype.reset=function(){this._actualMove=0,this._isFailed=!1,this._isSuccess=!1,this.generate()},i.prototype.retry=function(){this.reset(),this.triggerEvent(i.EVENT.retry,this)},i.prototype.onEnd=function(){this.board.directions.disableAllButtons(),this.triggerEvent(i.EVENT.end,this)},i}(UI.EventedTrait());i.EVENT=n,e.StageInstance=i,i.prototype.generate_predefined=i.prototype.generate_predefined}(Game||(Game={}));var Game;!function(e){var t=function(){function e(e){this.game=e}return e.prototype.check=function(e){return this.game.tiles.isColAligned(e)&&(this.targets[e]<0||this.targets[e]===this.game.tiles.get(0,e))},e.prototype.checkAll=function(){for(var e=this.game,t=this.targets,n=0,i=e.columns;n<i;n++)if(!e.tiles.isColAligned(n)||t[n]>=0&&t[n]!==e.tiles.get(0,n))return!1;return!0},e}(),n=function(n){function i(){return null!==n&&n.apply(this,arguments)||this}return __extends(i,n),Object.defineProperty(i.prototype,"targets",{get:function(){return this._targets.targets},enumerable:!0,configurable:!0}),i.prototype.createBar=function(){return e.Providers.uiProvider.createUIComponent("gameBarWithTargets")},i.prototype.createBoard=function(){return e.Providers.uiProvider.createUIComponent("gameBoard")},i.prototype.getRewardExtra=function(){if(this._isSuccess&&this.moves>0&&this._actualMove<this.moves)return{unit:"energy",quantity:1}},i.prototype.generate_predefined=function(){n.prototype.generate_predefined.call(this);var e=this.stageConfig;this._targets.targets=e.targets.split(",").map(function(e){return parseInt(e,10)}),this.moves=e.moves},i.prototype.generate=function(){this._targets||(this._targets=new t(this)),n.prototype.generate.call(this),this.moves>0?(this.bar.max=this.moves,this.bar.showProgressCounter=!0,this.bar.showProgress=!0):(this.bar.showProgressCounter=!1,this.bar.showProgress=!1)},i.prototype.start=function(){n.prototype.start.call(this),this.updateState()},i.prototype.reset=function(){n.prototype.reset.call(this),this.bar.setProgress(0)},i.prototype.advance=function(e){n.prototype.advance.call(this,e),this.updateState();var t=this._targets.checkAll(),i=this.moves>0&&this._actualMove===this.moves;(t||i)&&(this._isSuccess=t,this._isFailed=!this._isSuccess,this.onEnd())},i.prototype.updateState=function(){this.board.directions.enableAllButtons(),this.bar.setProgress(this._actualMove);for(var e=0;e<this.columns;e++)this.bar.targets[e].setFilled(this._targets.check(e))},i}(e.StageInstance);n.TYPE="sort",e.TypeSortInstance=n,n.prototype.generate_predefined=n.prototype.generate_predefined,e.manager.typeCatalogue[n.TYPE]=n}(Game||(Game={})),Element.prototype.hasOwnProperty("remove")||Object.defineProperty(Element.prototype,"remove",{configurable:!0,enumerable:!0,writable:!0,value:function(){this.parentNode.removeChild(this)}});var Game;!function(e){function t(e){var t=document.createElement("div");return t.setAttribute("class","tile tile-"+e),t}var n=function(){function e(){this.price=1,this.enabled=!1}return e}();e.PowerUp=n;var i=function(){function e(){this.showProgress=!1,this.node=document.createElement("div"),this.node.setAttribute("class","game-bar"),this.progressValue=document.createElement("p"),this.progressValue.setAttribute("class","bar-progress"),this.node.appendChild(this.progressValue)}return Object.defineProperty(e.prototype,"max",{get:function(){return this._max},set:function(e){this.progressValue.style.visibility=e<9999?"visible":"hidden",this._showProgressCounter=!1,this._max=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"showProgressCounter",{get:function(){return this._showProgressCounter},set:function(e){this.progressValue.style.visibility=e?"visible":"hidden",this._showProgressCounter=!1},enumerable:!0,configurable:!0}),e.prototype.setFgColor=function(e){},e.prototype.setProgress=function(e,t){this.progressValue.textContent=(this._max-e).toString()},e}(),r=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.targets=[],t}return __extends(t,e),t.prototype.initWithInstance=function(e){for(var t=0,n=this.targets;t<n.length;t++){var i=n[t];i.node.remove()}this.node.setAttribute("class","game-bar game-bar-withTargets");var r=e.targets;this.targets.length=r.length;for(var s=0;s<r.length;s++){var a=this.targets[s]=new o(r[s]);this.node.appendChild(a.node)}},t}(i),o=function(){function e(e){this.color=e,this.node=document.createElement("div"),this.setFilled(!1)}return e.prototype.setFilled=function(e){this.node.setAttribute("class","bar-target-"+this.color+(e?"-filled":""))},e}(),s=function(){function e(){var e=this.node=document.createElement("div");e.setAttribute("class","board");var t=this.tiles=new a;e.appendChild(t.node);var n=this.directions=new l;e.appendChild(n.node)}return e.prototype.initWithInstance=function(e){this.tiles.initWithInstance(this,e),this.directions.initWithInstance(this,e);var t=this.tiles.node;this.node.style.width=t.style.width,this.node.style.height=t.style.height},e.prototype.getTileSize=function(){return 48},e.prototype.getTileHSpacing=function(){return 18},e.prototype.getTileVSpacing=function(){return 18},e}(),a=function(){function n(){var e=this.node=document.createElement("div");e.setAttribute("class","board-tiles")}return n.prototype.initWithInstance=function(e,n){this.node.innerHTML="";for(var i=n.columns,r=n.rows,o=e.getTileHSpacing(),s=e.getTileVSpacing(),a=e.getTileSize(),l=n.tiles,u=this.tiles=new Array(i),c=this.positions=new Array(i),p=0;p<i;p++){u[p]=new Array(r),c[p]=new Array(r);for(var h=0;h<r;h++){var d=l.get(h,p),f=u[p][h]=t(d+1),g=c[p][h]={x:p*(a+o),y:h*(a+s)};f.style.left=g.x+"px",f.style.top=g.y+"px",this.node.appendChild(f)}}this.node.style.width=a*i+o*(i-1)+"px",this.node.style.height=a*r+s*(r-1)+0*a+"px"},n.prototype.shift=function(t,n){var i,r=this.tiles,o=this.positions,s=r.length-1,a=r[0].length-1;switch(t){case 1:for(this._shiftOut(r[n][a],o[n][0]),i=0;i<a;i++)this._shiftTo(r[n][i],o[n][i+1]);break;case 3:for(this._shiftOut(r[n][0],o[n][a]),i=a;i>0;i--)this._shiftTo(r[n][i],o[n][i-1]);break;case 0:for(this._shiftOut(r[0][n],o[s][n]),i=s;i>0;i--)this._shiftTo(r[i][n],o[i-1][n]);break;case 2:for(this._shiftOut(r[s][n],o[0][n]),i=0;i<s;i++)this._shiftTo(r[i][n],o[i+1][n])}e.TileGrid.prototype.shift.call(this,t,n)},n.prototype._shiftOut=function(e,t){e.style.opacity="0",setTimeout(function(){e.style.left=t.x+"px",e.style.top=t.y+"px"},200),setTimeout(function(){e.style.opacity="1"},400)},n.prototype._shiftTo=function(e,t){e.style.opacity="1",e.style.left=t.x+"px",e.style.top=t.y+"px"},n.prototype.flipAllDown=function(){throw new Error("Method not implemented.")},n.prototype.flipAllUp=function(){throw new Error("Method not implemented.")},n.prototype.setAllFlippedDown=function(){throw new Error("Method not implemented.")},n.prototype.setAllFlippedUp=function(){throw new Error("Method not implemented.")},n}(),l=function(t){function n(){var e=t.call(this)||this;return e.pauseEvents=!1,e.triggerGlobally=!0,e.throttleTimeout=.6,e._lastClick=0,e.node=document.createElement("div"),e.node.setAttribute("class","board-dirs"),e}return __extends(n,t),n.prototype.initWithInstance=function(e,t){this.node.innerHTML="";var n=t.columns,i=t.rows,r=e.getTileHSpacing(),o=e.getTileVSpacing(),s=e.getTileSize();this.node.style.width=s*n+r*(n-1)+0*s+"px",this.node.style.height=s*i+o*(i-1)+0*s+"px";var a,l,u,c=this._buttons=new Array(4);this._initButtonByDir(1,n,s),this._initButtonByDir(3,n,s),l=-s-o/5,u=s*i+o*(i-1)+o/2;for(var p=0;p<n;p++){a=p*(s+r);var h=c[1][p].node;h.style.left=a+"px",h.style.top=l+"px",h=c[3][p].node,h.style.left=a+"px",h.style.top=u+"px"}this._initButtonByDir(0,i,s),this._initButtonByDir(2,i,s),u=s*n+r*(n-1)+r/2;for(var p=0;p<i;p++){a=p*(s+o);var h=c[2][p].node;h.style.left=l+"px",h.style.top=a+"px",h=c[0][p].node,h.style.left=u+"px",h.style.top=a+"px"}},n.prototype._initButtonByDir=function(e,t,n){for(var i=this._buttons[e]=new Array(t),r=0;r<t;r++){var o=i[r]=new u(this,e,r);this.node.appendChild(o.node)}},n.prototype.register=function(){this.node.addEventListener("click",this._onClick.bind(this),!1)},n.prototype.unregister=function(){this.node.removeEventListener("click",this._onClick.bind(this))},n.prototype.disableAllButtons=function(){this._nextCmd=void 0;for(var e=0,t=this._buttons;e<t.length;e++)for(var n=t[e],i=0,r=n;i<r.length;i++){var o=r[i];o.setEnabled(!1)}},n.prototype.enableButtonByDir=function(e){if(this._checkThrottle(e)){this.disableAllButtons();for(var t=this._buttons[e],n=0;n<t.length;n++)t[n].setEnabled(!0)}},n.prototype.enableAllButtons=function(){if(this._checkThrottle("all"))for(var e=0,t=this._buttons;e<t.length;e++)for(var n=t[e],i=0,r=n;i<r.length;i++){var o=r[i];o.setEnabled(!0)}},n.prototype._checkThrottle=function(e){var t=this;if(this.throttleTimeout>0){var n=Date.now()-this._lastClick-1e3*this.throttleTimeout;if(n<0)return this._nextCmd=e,setTimeout(function(){t._processNextCommand()},-n),!1}return!0},n.prototype._processNextCommand=function(){"all"===this._nextCmd?this.enableAllButtons():void 0!==this._nextCmd&&this.enableButtonByDir(this._nextCmd)},n.prototype._onClick=function(t){var n=t.target&&t.target.btnSource;n&&n.isEnabled()&&(this.throttleTimeout>0&&(this.disableAllButtons(),this._lastClick=Date.now()),this.triggerEvent(e.GameDirectionsEVENT.shift,null,{direction:n.direction,index:n.index}))},n}(UI.EventedTrait()),u=function(){function e(e,t,n){this._isEnabled=!0,this.direction=t,this.index=n;var i=this.node=document.createElement("div");i.btnSource=this,i.setAttribute("class","btn-dir-"+t);var r=this.img=document.createElement("div");r.setAttribute("class","img-dir-"+t),r.btnSource=this,i.appendChild(r)}return e.prototype.isEnabled=function(){return this._isEnabled},e.prototype.setEnabled=function(e){this._isEnabled=e,this.img.setAttribute("class","img-dir-"+this.direction+(e?"":"-disabled"))},e}();e.Providers.scheduler={schedule:function(e,t,n){setTimeout(function(){t.call(n||null)},1e3*e)}};var c={};c.gameBarWithTargets=r,c.gameBoard=s,e.Providers||(e.Providers={}),e.Providers.uiProvider={createUIComponent:function(e){var t=c[e];if(!t)throw new Error("UIProvider: component "+e+" not registered");return new t}}}(Game||(Game={}));var Services;!function(e){function t(){return function(e,t){return{get:function(){return this["_"+t]},set:function(e){var n=this["_"+t];e!==n&&(this["_"+t]=e,this.onPropertyChanged&&this.onPropertyChanged(t,n))}}}}e.evented=t;var n=function(){function e(){this.tiles=0}return e.prototype.get=function(e){return"tiles"===e?this.tiles:0},e.prototype.delta=function(e,t){"tiles"===e&&(this.tiles+=t)},e}();e.UserInventory=n,e.userStats={currentLevel:0,maxLevel:0},e.userInventory=new n;var i=function(){function e(){}return e.prototype.load=function(e){throw new Error},e.prototype.loadData=function(e){throw new Error},e}();e.ResourceManager=i,e.resourceManager=new i;var r=[{index:0,stages:[{type:"sort",layout:"predefined",moves:0,targets:"-1,-1",ui:{noBar:!0},tiles:["1,0","0,1"],tutorial:{name:"t1",type:"inline",messageTitle:"Let's start",message:"Use the arrows to shift the blocks.\nAlign them to make all columns with a single color, that is, a green column and a red one."}},{type:"sort",layout:"predefined",moves:0,targets:"-1,-1",ui:{noBar:!0},tiles:["0,0","1,1"],tutorial:{name:"t1",type:"inline",messageTitle:"Going on",message:"Shift and align blocks vertically by color."}}]},{index:1,stages:[{type:"sort",layout:"predefined",moves:0,targets:"0,1",tiles:["1,1","0,0"],tutorial:{name:"t1",type:"inline",messageTitle:"Keep focus",message:"Match the color positions."}},{type:"sort",layout:"predefined",moves:0,targets:"1,3",tiles:["3,3","1,1","1,3"],tutorial:{name:"t1",type:"inline",messageTitle:"Motivation",message:"Easy, no?"}}]},{index:2,stages:[{type:"sort",layout:"predefined",moves:2,targets:"2,3",tiles:["2,3","2,2","3,3"],tutorial:{name:"t1",type:"inline",messageTitle:"Let's play serious now",message:"Use up to the specified moves\n(the little number on the right of the bar)."}},{type:"sort",layout:"predefined",moves:2,targets:"2,0,0",tiles:["0,0,2","0,2,0"],tutorial:{name:"t1",type:"inline",messageTitle:"TIP",message:"Pay attention on the number of moves...\nBe wise. Use useful shifts."}}]},{index:3,stages:[{type:"sort",layout:"predefined",moves:1,targets:"0,1,2",tiles:["0,1,2","2,0,1"],tutorial:{name:"t1",type:"inline",messageTitle:"Uhm...",message:"...three? The perfect number, isn't it?"}},{type:"sort",layout:"predefined",moves:3,targets:"0,3",tiles:["3,0","3,3","0,0"]}]},{index:4,stages:[{type:"sort",layout:"predefined",moves:2,targets:"2,0,3,1",tiles:["2,0,0,1","1,2,3,3"],tutorial:{name:"t1",type:"inline",messageTitle:"The boss",message:"Just to put some trouble?"}}]}],o=function(){function e(){}return e.prototype.get=function(e){return r[e]},e.prototype.isLastLevel=function(e){return r.length-1===e},e}();e.LevelCatalogue=o,e.levelCatalogue=new o;var s=function(){function e(){this._byMode={}}return e.prototype.initialize=function(){},e.prototype.enable=function(e){var t=this.powerups[e];t&&(t.enabled=!0)},e.prototype.disable=function(e){var t=this.powerups[e];t&&(t.enabled=!1)},e.prototype.get=function(e){return this.powerups[e]},e.prototype.getByMode=function(e){var t=this._byMode[e];if(!t){t=this._byMode[e]=[];for(var n in this.powerups)this.powerups[n].stageTypes.indexOf(e)>=0&&t.push(this.powerups[n])}return t},e}();e.PowerUpCatalogue=s,e.powerupCatalogue=new s}(Services||(Services={}));var userInventory=Services.userInventory,userStats=Services.userStats,powerupCatalogue=Services.powerupCatalogue,levelCatalogue=Services.levelCatalogue,resourceManager=Services.resourceManager,Scenes;!function(e){var t=function(){function e(e){this.parent=e}return e.prototype.initWithInstance=function(e){var t=this;this.node&&this.node.remove();var n=e.stageConfig.tutorial;if(n&&"inline"===n.type){if(this.node=document.createElement("div"),this.node.style.opacity="0",this.node.setAttribute("class","tutorial"),n.messageTitle){var i=document.createElement("p");i.setAttribute("class","tutorial-title"),i.textContent=n.messageTitle,this.node.appendChild(i)}if(n.message){var r=document.createElement("p");r.setAttribute("class","tutorial-msg"),r.textContent=n.message,this.node.appendChild(r)}this.parent.appendChild(this.node),setTimeout(function(){t.node.style.opacity="1"},600);var o=e.addEventListener(Game.StageInstance.EVENT.end,function(){o.unregister(),setTimeout(function(){t.node.style.opacity="0",setTimeout(function(){t.node.remove(),t.node=null},400)},600)},this,!0)}},e}();t.TYPE="inline",e.TutorialInline=t;var n=function(){function e(e,t){this.name=e,this.scene=t,this.node=document.createElement("div"),this.node.setAttribute("class","screen-"+e)}return e.prototype.onEnter=function(e){},e.prototype.onLeave=function(){},e}(),i=function(e){function n(n){var i=e.call(this,"level",n)||this,r=i.hudTile=document.createElement("p");r.setAttribute("class","hudTile"),i.node.appendChild(r);var o=document.createElement("span");o.setAttribute("class","hudTile-title"),o.textContent="Collected",r.appendChild(o);var s=i.tileNumber=document.createElement("span");s.setAttribute("class","hudTile-number"),s.textContent=userInventory.tiles.toString(),r.appendChild(s);var a=document.createElement("span");a.setAttribute("class","hudTile-icon"),r.appendChild(a);var l=i.levelNumber=document.createElement("span");l.setAttribute("class","hud-levelNumber"),l.style.display="none",i.node.appendChild(l);var u=i.settings=document.createElement("div");u.className="settings";var c=document.createElement("input");c.type="checkbox",c.id="colorblind",c.addEventListener("click",function(){c.checked?i.node.classList.add("colorblind"):i.node.classList.remove("colorblind")}),u.appendChild(c);var p=document.createElement("label");return p.setAttribute("for","colorblind"),p.textContent="Color Blind",u.appendChild(p),i.node.appendChild(u),i.tutorial=new t(i.node),i}return __extends(n,e),n.prototype.onEnter=function(e){this.node.style.opacity="",this.node.style.display="block";var t=e;this.createStage(t.level,t.stage)},n.prototype.createStage=function(e,t){var n=levelCatalogue.get(e||0),i=this.instance=gameManager.newStage(n.index,t||0,n);i.addEventListener(Game.StageInstance.EVENT.end,this._onInstanceEnd,this),this.enterUI(),setTimeout(function(){i.start()},1500)},n.prototype.retry=function(){var e=this;this.instance.retry(),this.enterUI(),setTimeout(function(){e.instance.start()},1500)},n.prototype.enterUI=function(){var e=this;this.bar&&this.bar.node.remove(),this.board&&this.board.node.remove();var t=this.instance;this.node.classList.add("game-success"),this.bar=t.getBar(),this.board=t.getBoard(),this.node.appendChild(this.bar.node),this.node.appendChild(this.board.node),this.bar.node.style.visibility=t.stageConfig.ui&&t.stageConfig.ui.noBar?"hidden":"visible",this.tutorial.initWithInstance(t),this.node.insertBefore(this.settings,this.tutorial.node);for(var n=this.board.node.querySelectorAll(".tile"),i=0,r=n;i<r.length;i++){var o=r[i];o.style.opacity="0"}setTimeout(function(){e.node.classList.remove("game-success");for(var t=0,i=n;t<i.length;t++){var r=i[t];r.style.opacity="1"}},500)},n.prototype.onLeave=function(){var e=this;this.node.style.transition="0.8s opacity",this.node.style.opacity="0",setTimeout(function(){e.node.innerHTML="",e.node.style.display="none"},900)},n.prototype._onInstanceEnd=function(){var e=this,t=this.instance;setTimeout(function(){e.node.classList.add("game-success")},1e3);var n=document.querySelectorAll("#ermo-container .tile");setTimeout(function(){for(var e=0,t=n;e<t.length;e++){var i=t[e];i.style.opacity="0"}},1650),t.isSuccess?(setTimeout(function(){for(var i=document.querySelector("#ermo-container .hudTile-icon"),r=i.getBoundingClientRect(),o=n[0],s=o.getBoundingClientRect(),a=s.left-parseInt(o.style.left,10),l=s.top-parseInt(o.style.top,10),u=10,c=r.left-a-u+"px",p=r.top-l-u+"px",h=0,d=n;h<d.length;h++){var f=d[h];f.style.left=c,f.style.top=p,f.style.transform="rotate("+(180+720*Math.random()|0)+"deg) scale(.5)"}userInventory.tiles+=t.tileCount;var g=userInventory.tiles-t.tileCount,v=userInventory.tiles,y=setInterval(function(){g++,e.tileNumber.textContent=g.toString(),g>=v&&clearInterval(y)},50)},1500),setTimeout(function(){e._goNext()},1800)):setTimeout(function(){e._showFailed()},1900)},n.prototype._goNext=function(){var e=this;if(this.instance.isLastStage)if(levelCatalogue.isLastLevel(this.instance.level))setTimeout(function(){ermo.end(userInventory.tiles)||e.scene.navigateTo("complete",{tiles:userInventory.tiles})},400);else{var t=this.levelNumber;t.textContent=(this.instance.level+2).toString(),t.style.display="block",t.style.top=this.board.node.offsetTop-32+"px",setTimeout(function(){t.style.opacity="1",t.style.left="50%"},10),setTimeout(function(){t.style.opacity="0",t.style.left="25%"},1200),setTimeout(function(){t.style.left="75%",t.style.display="none",e.createStage(e.instance.level+1,0)},1800)}else this.createStage(this.instance.level,this.instance.stage+1)},n.prototype._showFailed=function(){var e=this,t=document.createElement("div");t.setAttribute("class","game-failed"),t.innerHTML='\n                <p class="failed-title">: (<br/>Oh! Blocks messed up!</p>\n                <p class="failed-sub">Basic rules</p>\n                <ul class="failed-steps">\n                    <li>Shift the tiles in horizontal and vertical</li>\n                    <li>Make columns of one single color</li>\n                    <li>Match color positions as the indicators</li>\n                    <li>Do not exceed the number of moves available</li>\n                </ul>\n            ';var n=document.createElement("a");n.setAttribute("class","btn btn-retry"),n.textContent="Retry",t.appendChild(n),this.node.insertBefore(t,this.hudTile.nextSibling),n.addEventListener("click",function(){t.remove(),e.retry()})},n}(n),r=function(e){function t(n){return e.call(this,t.NAME,n)||this}return __extends(t,e),t.prototype.onEnter=function(e){var t=this,n=e&&e.tiles;this.node.style.display="none",this.node.style.opacity="0",this.node.style.transition="2s opacity",this.node.innerHTML='\n                <p class="title">YOU MADE IT</p>\n                <p class="result">You collected all the <span class="collected">'+n+'</span> blocks</p>\n                <p class="subtitle">Looks like you enjoy ERMO<p>\n                <p class="desc">\n                    Thankfully, ERMO doesn\'t ends here!\n                    ERMO is available for iOS, Android and Windows!\n\n                    Download ERMO to get more levels, many game modes, special powers, and lots more to challenge your mind.\n                </p>\n            ';var i=document.createElement("a");i.setAttribute("class","btn btn-download"),i.textContent="Download",this.node.appendChild(i),i.addEventListener("click",function(){ermo.goToDownload()}),setTimeout(function(){t.node.style.display="block",setTimeout(function(){t.node.style.opacity="1"},10)},1100)},t.prototype.onLeave=function(){},t}(n);r.NAME="complete";var o=function(){function e(){this.screens={},this.node=document.createElement("div"),this.node.setAttribute("class","scene-game"),[i,r].forEach(function(e){var t=new e(this);this.screens[t.name]=t,this.node.appendChild(t.node)},this)}return e.prototype.navigateTo=function(e,t){eventHelper.raise("screen_changed",e),this.actualScreenName&&this.screens[this.actualScreenName].onLeave(),this.actualScreenName=e,this.screens[e].onEnter(t)},e}();e.GameScene=o}(Scenes||(Scenes={}));var EventHelper=function(){function e(){this.map={}}return e.prototype.raise=function(e,t){if(this.map[e]){for(var n=[],i=0,r=this.map[e];i<r.length;i++){var o=r[i],s=o.args||[];s?t&&s.push(t):t&&(s=[t]),o.cb.apply(o.ctx,s),o.once&&n.push(o.id)}this.dispose(n)}},e.prototype.subscribe=function(e,t,n){for(var i=[],r=3;r<arguments.length;r++)i[r-3]=arguments[r];var o=this.map[e]||(this.map[e]=[]);return o.push({id:builda.utils.newguid(),cb:t,ctx:n,args:i}),o[o.length-1].id},e.prototype.subscribeOnce=function(e,t,n){for(var i=[],r=3;r<arguments.length;r++)i[r-3]=arguments[r];this.subscribe(e,t,n,i),this.map[e][this.map[e].length-1].once=!0},e.prototype.dispose=function(e){if(e&&!(e.length<1))if(Array.isArray(e))for(var t=0,n=e;t<n.length;t++){var i=n[t];this.dispose(i)}else{var r=this.map;for(var o in r)for(var s=r[o],a=0;a<s.length;a++)if(s[a].id===e)return void s.splice(a,1)}},e}(),eventHelper=new EventHelper,builda={utils:{newguid:function(){var e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),
("x"==t?n:7&n|8).toString(16)})}}},ermo={_endCb:null,version:"1.0.3",bootstrap:function(e){function t(e){return"stage"+(e.level+1)+"-"+(e.stage+1)}ermo._endCb=e,console.log("ERMO mini started\nv"+ermo.version+"\n\nEnjoy :)");var n=new Scenes.GameScene,i=document.querySelector("#ermo-container");if(!i)return void console.warn("No ermo container defined");var r="ontouchstart"in document.documentElement||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0;i.setAttribute("class",r?"touch":"no-touch");var o=window.ga;if(o){o("send","event","ermo-mini","started"),eventHelper.subscribe(Game.StageInstance.EVENT.start,function(e){o("send","event","ermo-mini","stage-start",t(e))}),eventHelper.subscribe(Game.StageInstance.EVENT.end,function(e){o("send","event","ermo-mini","stage-"+(e.isSuccess?"success":"failed"),t(e))}),eventHelper.subscribe(Game.StageInstance.EVENT.retry,function(e){o("send","event","ermo-mini","stage-retry",t(e))});var s=ermo.goToDownload;ermo.goToDownload=function(){o("send","event","ermo-mini","download",{hitCallback:s}),setTimeout(s,1e3)};var a=ermo.end;ermo.end=function(e){return o("send","event","ermo-mini","completed"),a(e)}}i.appendChild(n.node),n.navigateTo("level",{level:0,stage:0})},end:function(e){return ermo._endCb&&ermo._endCb(e),!!ermo._endCb},goToDownload:function(){window.location.href="http://www.nonostante.io/games/ermo/download.html"}};window.ermo=ermo,window.ermo.bootstrap=ermo.bootstrap;